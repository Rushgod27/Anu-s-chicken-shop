<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sales Intelligence Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(135deg,#eef2ff,#f8fafc);
  color:#1f2937;
}
.header{
  background:linear-gradient(135deg,#111827,#1f2937);
  color:#fff;
  padding:18px;
  font-size:22px;
  font-weight:900;
  text-align:center;
}
.container{
  max-width:1300px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:18px;
  margin-bottom:20px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}
input[type="date"]{
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #ddd;
  margin-right:10px;
}
button{
  padding:8px 14px;
  border:none;
  border-radius:6px;
  background:#4f46e5;
  color:white;
  font-weight:700;
  cursor:pointer;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:15px;
}
.kpi{
  background:#f9fafb;
  padding:16px;
  border-radius:12px;
}
.kpi-title{
  font-size:13px;
  color:#6b7280;
  margin-bottom:6px;
}
.kpi-value{
  font-size:20px;
  font-weight:900;
}
.small{
  font-size:14px;
  font-weight:600;
  color:#6b7280;
}
</style>
</head>

<body>

<div class="header">üìä Anu‚Äôs Chicken Shop ‚Äì Intelligence Dashboard</div>

<div class="container">

<!-- Date Filter -->
<div class="card">
  <h3>Date Range Filter</h3>
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button id="loadBtn">Load</button>
</div>

<!-- Live Stock -->
<div class="card">
  <h3>üì¶ Stocks Available (Live)</h3>
  <div class="grid">

    <div class="kpi">
      <div class="kpi-title">üêî Broiler</div>
      <div class="kpi-value">
        <span id="broilerSold">0</span> /
        <span id="broilerAvail">0</span> kg
      </div>
      <div class="small">Sold / Sellable</div>
    </div>

    <div class="kpi">
      <div class="kpi-title">üêì Country</div>
      <div class="kpi-value">
        <span id="countrySold">0</span> /
        <span id="countryAvail">0</span> kg
      </div>
      <div class="small">Sold / Sellable</div>
    </div>

    <div class="kpi">
      <div class="kpi-title">ü•ö Eggs</div>
      <div class="kpi-value">
        <span id="eggSold">0</span> /
        <span id="eggAvail">0</span>
      </div>
      <div class="small">Sold / Available</div>
    </div>

    <div class="kpi">
      <div class="kpi-title">üå∂ Masala</div>
      <div class="kpi-value">
        <span id="masalaSold">0</span> /
        <span id="masalaAvail">0</span>
      </div>
      <div class="small">Sold / Available</div>
    </div>

  </div>
</div>

<!-- Executive Summary -->
<div class="card">
  <h3>Executive Summary</h3>
  <div class="grid">

    <div class="kpi">
      <div class="kpi-title">Sales & Cost</div>
      <div class="kpi-value">‚Çπ <span id="totalSales">0</span></div>
      <div class="small">Cost ‚Çπ <span id="totalCost">0</span></div>
    </div>

    <div class="kpi">
      <div class="kpi-title">Collection</div>
      <div class="kpi-value">Cash ‚Çπ <span id="totalCash">0</span></div>
      <div class="small">Online ‚Çπ <span id="totalOnline">0</span></div>
    </div>

    <div class="kpi">
      <div class="kpi-title">Profit</div>
      <div class="kpi-value">‚Çπ <span id="totalProfit">0</span></div>
      <div class="small"><span id="profitPercent">0</span>% Margin</div>
    </div>

    <div class="kpi">
      <div class="kpi-title">Business Activity</div>
      <div class="kpi-value"><span id="totalBills">0</span> Bills</div>
      <div class="small">Best: <span id="bestProduct">-</span></div>
    </div>

  </div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

initializeApp({
  apiKey:"AIzaSyComVLxo36wvogoBFEoWyea-_yESW9BIPU",
  authDomain:"anus-chicken-shop.firebaseapp.com",
  projectId:"anus-chicken-shop"
});

const db = getFirestore();

function todayLocal(){
  return new Date().toISOString().slice(0,10);
}

fromDate.value = todayLocal();
toDate.value = todayLocal();

loadBtn.addEventListener("click", loadData);

async function loadData(){

  const from = fromDate.value;
  const to   = toDate.value;

  /* ========== LIVE STOCK ========== */

  const liveSnap = await getDoc(doc(db,"stock_current","live"));
  if(liveSnap.exists()){
    const live = liveSnap.data();

    broilerSold.innerText  = live.broiler?.soldKg ?? 0;
    broilerAvail.innerText = live.broiler?.availableKg ?? 0;

    countrySold.innerText  = live.country?.soldKg ?? 0;
    countryAvail.innerText = live.country?.availableKg ?? 0;

    eggSold.innerText      = live.eggs?.sold ?? 0;
    eggAvail.innerText     = live.eggs?.available ?? 0;

    masalaSold.innerText   = live.masala?.soldAmount ?? 0;
    masalaAvail.innerText  = live.masala?.availableAmount ?? 0;
  }

  /* ========== SALES SUMMARY ========== */

  const snap = await getDocs(collection(db,"sales"));

  let totalSales=0,totalCost=0,totalProfit=0,totalBills=0;
  let totalCash=0,totalOnline=0;

  let productProfit={
    Broiler:0,Country:0,Eggs:0,Masala:0
  };

  snap.forEach(doc=>{
    const s=doc.data();
    if(!s.date) return;
    if(s.date < from || s.date > to) return;

    totalSales += Number(s.total||0);
    totalCost  += Number(s.totalCost||0);
    totalProfit+= Number(s.profit||0);
    totalBills++;

    if(s.payment==="cash") totalCash += Number(s.total||0);
    if(s.payment==="online") totalOnline += Number(s.total||0);

    if(s.items?.broiler)
      productProfit.Broiler += (Number(s.items.broiler.amount)-Number(s.items.broiler.cost));

    if(s.items?.country)
      productProfit.Country += (Number(s.items.country.amount)-Number(s.items.country.cost));

    if(s.items?.eggs)
      productProfit.Eggs += (Number(s.items.eggs.amount)-Number(s.items.eggs.cost));

    if(s.items?.masala)
      productProfit.Masala += (Number(s.items.masala.amount)-Number(s.items.masala.cost));
  });

  const profitPercent = totalSales ? (totalProfit/totalSales*100) : 0;
  const best = Object.keys(productProfit)
    .reduce((a,b)=>productProfit[a]>productProfit[b]?a:b,"Broiler");

  totalSales.innerText=totalSales.toFixed(2);
  totalCost.innerText=totalCost.toFixed(2);
  totalProfit.innerText=totalProfit.toFixed(2);
  profitPercent.innerText=profitPercent.toFixed(2);
  totalCash.innerText=totalCash.toFixed(2);
  totalOnline.innerText=totalOnline.toFixed(2);
  totalBills.innerText=totalBills;
  bestProduct.innerText=best;
}

loadData();

</script>
</body>
</html>