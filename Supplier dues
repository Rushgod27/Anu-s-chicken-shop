<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supplier Dues</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f1f5f9;
}
.header{
  background:#b91c1c;
  color:#fff;
  padding:16px;
  font-size:24px;
  font-weight:900;
  text-align:center;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:16px;
  margin-bottom:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}
.row{
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:8px;
}
button{
  padding:8px 12px;
  border:none;
  border-radius:8px;
  background:#16a34a;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
input, select{
  padding:6px;
  border-radius:6px;
  border:1px solid #cbd5f5;
}
.small{
  font-size:13px;
}
</style>
</head>

<body>

<div class="header">ðŸ’³ Supplier Dues</div>

<div class="container">

<div class="card">
<h3>Total Outstanding Dues</h3>
â‚¹ <span id="totalDue">0</span>
</div>

<div id="supplierContainer"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
getFirestore, collection, getDocs,
updateDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

initializeApp({
apiKey:"AIzaSyComVLxo36wvogoBFEoWyea-_yESW9BIPU",
authDomain:"anus-chicken-shop.firebaseapp.com",
projectId:"anus-chicken-shop"
});

const db=getFirestore();

async function loadDues(){

const snap=await getDocs(collection(db,"stock_entries"));

let suppliers={};
let totalOutstanding=0;

snap.forEach(d=>{
const s=d.data();
if(s.paymentStatus!=="credit") return;

const totalCost=s.totalCost||0;
const payments=s.payments||[];
const paid=payments.reduce((a,p)=>a+(p.amount||0),0);
const due=totalCost-paid;

if(due<=0) return;

if(!suppliers[s.supplier]){
suppliers[s.supplier]={
total:0,
entries:[]
};
}

suppliers[s.supplier].total+=due;
suppliers[s.supplier].entries.push({
id:d.id,
type:s.type,
date:s.date,
totalCost,
paid,
due
});

totalOutstanding+=due;
});

document.getElementById("totalDue").innerText=
totalOutstanding.toFixed(2);

const container=document.getElementById("supplierContainer");

container.innerHTML=Object.keys(suppliers).map(name=>{

const sup=suppliers[name];

return `
<div class="card">
<h3>${name}</h3>
<div class="row">
<div>Total Due:</div>
<div>â‚¹ ${sup.total.toFixed(2)}</div>
</div>

${sup.entries.map(e=>`
<div class="card small">
<div class="row">
<div>${e.type.toUpperCase()} (${e.date})</div>
<div>Due â‚¹ ${e.due.toFixed(2)}</div>
</div>

<div class="row">
<input type="number" id="pay-${e.id}" placeholder="Enter Amount">
<select id="method-${e.id}">
<option value="cash">Cash</option>
<option value="online">Online</option>
</select>
<button onclick="makePayment('${e.id}',${e.due})">
Pay
</button>
</div>
</div>
`).join("")}

</div>
`;

}).join("") || "<div class='card'>No outstanding dues</div>";
}

window.makePayment=async(id,maxDue)=>{

const amount=+document.getElementById(`pay-${id}`).value||0;
const method=document.getElementById(`method-${id}`).value;

if(amount<=0){
alert("Enter valid amount");
return;
}

if(amount>maxDue){
alert("Cannot pay more than due");
return;
}

const ref=doc(db,"stock_entries",id);

const snap=await getDocs(collection(db,"stock_entries"));
let target=null;

snap.forEach(d=>{
if(d.id===id) target=d.data();
});

const payments=target.payments||[];

payments.push({
amount,
method,
date:new Date().toISOString().slice(0,10)
});

await updateDoc(ref,{
payments
});

alert("Payment recorded");
location.reload();
};

loadDues();

</script>

</body>
</html>
