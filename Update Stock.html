<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

<title>Stock Update ‚Äì Anu‚Äôs Chicken Shop</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f1f5f9;
}
.header{
  background:linear-gradient(135deg,#14532d,#166534);
  color:#fff;
  padding:18px;
  font-size:26px;
  font-weight:900;
  text-align:center;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
.card{
  background:#fff;
  border-radius:18px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
h3{
  margin:0 0 14px;
  font-size:20px;
}
.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
input,select,button{
  padding:14px;
  font-size:16px;
  border-radius:12px;
  border:1px solid #cbd5f5;
}
input,select{flex:1}
button{
  background:#166534;
  color:#fff;
  font-weight:900;
  border:none;
}
.info{
  background:#ecfeff;
  padding:12px;
  border-radius:12px;
  color:#155e75;
  font-size:14px;
  margin-top:10px;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="header">üì¶ Stock Update</div>

<div class="container">

<!-- SUPPLIER -->
<div class="card">
<h3>Supplier Details</h3>
<div class="row">
  <input id="date" type="date">
  <input id="supplier" placeholder="Supplier Name">
</div>
</div>

<!-- ITEM -->
<div class="card">
<h3>Item Received</h3>

<div class="row">
  <select id="item" onchange="onItemChange()">
    <option value="">Select Item</option>
    <option value="broiler">üêî Broiler</option>
    <option value="country">üêì Country</option>
    <option value="eggs">ü•ö Eggs</option>
    <option value="masala">üå∂Ô∏è Masala</option>
  </select>
</div>

<!-- BROILER -->
<div id="broilerBox" class="hidden">
  <div class="row">
    <input id="broilerLiveKg" placeholder="Live KG">
    <input id="broilerCost" placeholder="Total Cost ‚Çπ">
  </div>
  <div class="info" id="broilerInfo"></div>
</div>

<!-- COUNTRY -->
<div id="countryBox" class="hidden">
  <div class="row">
    <input id="countryLiveKg" placeholder="Live KG">
    <input id="countryCost" placeholder="Total Cost ‚Çπ">
  </div>
  <div class="info" id="countryInfo"></div>
</div>

<!-- EGGS -->
<div id="eggBox" class="hidden">
  <div class="row">
    <input id="eggQty" placeholder="Egg Quantity">
    <input id="eggCost" placeholder="Total Cost ‚Çπ">
  </div>
  <div class="info" id="eggInfo"></div>
</div>

<!-- MASALA -->
<div id="masalaBox" class="hidden">
  <div class="row">
    <input id="masalaAmount" placeholder="Stock Value ‚Çπ">
    <input id="masalaCost" placeholder="Total Cost ‚Çπ">
  </div>
  <div class="info">
    Masala stock is tracked by ‚Çπ value (no quantity / waste)
  </div>
</div>

<button onclick="saveStock()">SAVE STOCK</button>

</div>

</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  doc, getDoc, setDoc,
  serverTimestamp
} from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

initializeApp({
  apiKey:"AIzaSyComVLxo36wvogoBFEoWyea-_yESW9BIPU",
  authDomain:"anus-chicken-shop.firebaseapp.com",
  projectId:"anus-chicken-shop"
});
const db = getFirestore();

date.value = new Date().toISOString().slice(0,10);
const WASTE = 0.25;

window.onItemChange = () => {
  broilerBox.classList.add("hidden");
  countryBox.classList.add("hidden");
  eggBox.classList.add("hidden");
  masalaBox.classList.add("hidden");

  if(item.value==="broiler") broilerBox.classList.remove("hidden");
  if(item.value==="country") countryBox.classList.remove("hidden");
  if(item.value==="eggs") eggBox.classList.remove("hidden");
  if(item.value==="masala") masalaBox.classList.remove("hidden");
};

/* ENSURE LIVE STOCK */
async function ensureLive(){
  const ref = doc(db,"stock_current","live");
  const snap = await getDoc(ref);
  if(!snap.exists()){
    await setDoc(ref,{
      broiler:{availableKg:0,soldKg:0},
      country:{availableKg:0,soldKg:0},
      eggs:{available:0,sold:0},
      masala:{availableAmount:0,soldAmount:0}
    });
  }
}

async function addToLive(update){
  await ensureLive();
  const ref = doc(db,"stock_current","live");
  const s = (await getDoc(ref)).data();

  if(update.broilerKg) s.broiler.availableKg += update.broilerKg;
  if(update.countryKg) s.country.availableKg += update.countryKg;
  if(update.eggs) s.eggs.available += update.eggs;
  if(update.masalaAmount) s.masala.availableAmount += update.masalaAmount;

  await setDoc(ref,{...s,updatedAt:serverTimestamp()});
}

window.saveStock = async () => {
  if(!item.value){alert("Select item");return;}
  if(!supplier.value){alert("Enter supplier name");return;}

  const base={
    date:date.value,
    supplier:supplier.value,
    type:item.value,
    createdAt:serverTimestamp()
  };

  let update={};

  if(item.value==="broiler"){
    const live=+broilerLiveKg.value||0;
    const cost=+broilerCost.value||0;
    if(live<=0)return alert("Enter live kg");

    const sellable=live*(1-WASTE);

    await addDoc(collection(db,"stock"),{
      ...base,
      liveKg:live,
      sellableKg:+sellable.toFixed(2),
      cost,
      costPerLiveKg:+(cost/live).toFixed(2),
      costPerSellableKg:+(cost/sellable).toFixed(2),
      wastePercent:25
    });

    update.broilerKg=sellable;
  }

  if(item.value==="country"){
    const live=+countryLiveKg.value||0;
    const cost=+countryCost.value||0;
    if(live<=0)return alert("Enter live kg");

    await addDoc(collection(db,"stock"),{
      ...base,
      liveKg:live,
      cost,
      costPerKg:+(cost/live).toFixed(2)
    });

    update.countryKg=live;
  }

  if(item.value==="eggs"){
    const qty=+eggQty.value||0;
    const cost=+eggCost.value||0;
    if(qty<=0)return alert("Enter quantity");

    await addDoc(collection(db,"stock"),{
      ...base,
      quantity:qty,
      cost,
      costPerEgg:+(cost/qty).toFixed(2)
    });

    update.eggs=qty;
  }

  if(item.value==="masala"){
    const amt=+masalaAmount.value||0;
    const cost=+masalaCost.value||0;
    if(amt<=0)return alert("Enter masala amount");

    await addDoc(collection(db,"stock"),{
      ...base,
      amount:amt,
      cost,
      margin:amt-cost
    });

    update.masalaAmount=amt;
  }

  await addToLive(update);

  alert("Stock updated successfully");
  location.reload();
};
</script>

</body>
</html>