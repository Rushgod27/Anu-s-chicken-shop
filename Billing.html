<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Anu‚Äôs Chicken Shop ‚Äì Billing</title>

<style>
html,body{
  margin:0;
  padding:0;
  font-family:system-ui;
  background:#f1f5f9;
  -webkit-text-size-adjust:100%;
  touch-action:manipulation;
}
*{box-sizing:border-box}

.header{
  background:linear-gradient(135deg,#fbbf24,#f59e0b);
  padding:14px;
  font-size:26px;
  font-weight:900;
  text-align:center
}

.container{max-width:1400px;margin:auto;padding:10px}
.main{display:grid;grid-template-columns:1fr 460px;gap:14px}

.card{
  background:#fff;
  border-radius:18px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.05)
}

.row{display:flex;gap:10px;margin-bottom:10px}

input{
  width:100%;
  padding:16px;
  font-size:20px;
  border-radius:14px;
  border:1px solid #cbd5f5;
}

.btn{
  flex:1;
  padding:14px;
  font-size:16px;
  font-weight:800;
  border:none;
  border-radius:14px;
  background:#e5e7eb
}
.btn.active{background:#fbbf24}

.primary{
  width:100%;
  padding:18px;
  font-size:22px;
  font-weight:900;
  border:none;
  border-radius:16px;
  background:#4f46e5;
  color:#fff
}

.total{
  background:#dbeafe;
  font-size:26px;
  font-weight:900;
  padding:14px;
  border-radius:16px;
  text-align:center
}

.return{
  background:#dcfce7;
  font-size:18px;
  font-weight:900;
  padding:12px;
  border-radius:14px
}
.return.negative{background:#fee2e2;color:#991b1b}

.keypad-wrap{
  position:sticky;
  top:10px;
  height:95vh;
}

.keypad{
  background:#111827;
  border-radius:30px;
  padding:22px;
  height:100%;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:20px;
}

.keypad button{
  font-size:36px;
  font-weight:900;
  border:none;
  border-radius:26px;
  background:#374151;
  color:#fff;
  min-height:90px;
}

.keypad .del{background:#ef4444}
</style>
</head>

<body>

<div class="header">üêî Anu‚Äôs Chicken Shop ‚Äì Billing</div>

<div class="container">
<div class="main">

<div>

<div class="card">
<h3>Today‚Äôs Prices</h3>
<div class="row">
<input id="broilerPrice" readonly>
<input id="countryPrice" readonly>
<input id="eggPrice" readonly>
</div>
<button class="primary" onclick="savePrices()">Save Prices</button>
</div>

<div class="card">
<h3>Add Items</h3>
<div class="row">
<button class="btn" onclick="toggleItem('broiler',this)">Broiler</button>
<button class="btn" onclick="toggleItem('country',this)">Country</button>
<button class="btn" onclick="toggleItem('egg',this)">Eggs</button>
<button class="btn" onclick="toggleItem('masala',this)">Masala</button>
</div>
</div>

<div class="card" id="broilerBox" style="display:none">
<h3>Broiler</h3>
<div class="row">
<button class="btn" onclick="setMode('broiler','kg',this)">KG</button>
<button class="btn" onclick="setMode('broiler','rs',this)">‚Çπ</button>
</div>
<input id="broilerKg" readonly>
<input id="broilerRs" style="display:none" readonly>
</div>

<div class="card" id="countryBox" style="display:none">
<h3>Country</h3>
<div class="row">
<button class="btn" onclick="setMode('country','kg',this)">KG</button>
<button class="btn" onclick="setMode('country','rs',this)">‚Çπ</button>
</div>
<input id="countryKg" readonly>
<input id="countryRs" style="display:none" readonly>
</div>

<div class="card" id="eggBox" style="display:none">
<h3>Eggs</h3>
<input id="eggQty" readonly>
</div>

<div class="card" id="masalaBox" style="display:none">
<h3>Masala</h3>
<input id="masalaAmt" readonly>
</div>

<div class="card">
<h3>Payment</h3>
<div class="row">
<button class="btn" onclick="setPayment('cash',this)">Cash</button>
<button class="btn" onclick="setPayment('online',this)">Online</button>
</div>
<input id="received" style="display:none" readonly>
<div id="returnBox" class="return" style="display:none">
Return ‚Çπ <span id="returnAmt">0.00</span>
</div>
</div>

<div class="card">
<div class="total">TOTAL ‚Çπ <span id="total">0.00</span></div>
<button class="primary" onclick="confirmSale()">SALE</button>
</div>

<!-- TODAY SALES -->
<div class="card">
<h3>üßæ Today Sales</h3>
<div id="todaySummary" style="font-weight:800;margin-bottom:10px"></div>
<div id="todayList">Loading...</div>
</div>

</div>

<div class="keypad-wrap">
<div class="keypad">
<button onclick="add('7')">7</button>
<button onclick="add('8')">8</button>
<button onclick="add('9')">9</button>
<button onclick="add('4')">4</button>
<button onclick="add('5')">5</button>
<button onclick="add('6')">6</button>
<button onclick="add('1')">1</button>
<button onclick="add('2')">2</button>
<button onclick="add('3')">3</button>
<button onclick="add('0')">0</button>
<button onclick="add('.')">.</button>
<button class="del" onclick="del()">‚å´</button>
</div>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
getFirestore, collection, addDoc, query,
where, orderBy, getDocs, serverTimestamp,
updateDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

initializeApp({
apiKey:"AIzaSyComVLxo36wvogoBFEoWyea-_yESW9BIPU",
authDomain:"anus-chicken-shop.firebaseapp.com",
projectId:"anus-chicken-shop"
});

const db=getFirestore();
const today=new Date().toISOString().slice(0,10);

let activeInput=null,payment=null;
let active={broiler:false,country:false,egg:false,masala:false};
let mode={broiler:"kg",country:"kg"};

document.querySelectorAll("input").forEach(i=>i.onclick=()=>activeInput=i);
window.add=v=>{if(activeInput){activeInput.value+=v;calc()}};
window.del=()=>{if(activeInput){activeInput.value=activeInput.value.slice(0,-1);calc()}};

window.toggleItem=(t,b)=>{
active[t]=!active[t];
b.classList.toggle("active");
document.getElementById(t+"Box").style.display=active[t]?"block":"none";
calc();
};

window.setMode=(t,m,b)=>{
mode[t]=m;
b.parentElement.querySelectorAll(".btn").forEach(x=>x.classList.remove("active"));
b.classList.add("active");
document.getElementById(t+"Kg").style.display=m==="kg"?"block":"none";
document.getElementById(t+"Rs").style.display=m==="rs"?"block":"none";
};

window.setPayment=(p,b)=>{
payment=p;
b.parentElement.querySelectorAll(".btn").forEach(x=>x.classList.remove("active"));
b.classList.add("active");
received.style.display=p==="cash"?"block":"none";
returnBox.style.display=p==="cash"?"block":"none";
};

function calc(){
let t=0;
if(active.broiler)t+=(mode.broiler==="kg"?+broilerKg.value:(+broilerRs.value/+broilerPrice.value||0))*+broilerPrice.value;
if(active.country)t+=(mode.country==="kg"?+countryKg.value:(+countryRs.value/+countryPrice.value||0))*+countryPrice.value;
if(active.egg)t+=(+eggQty.value||0)*(+eggPrice.value||0);
if(active.masala)t+=(+masalaAmt.value||0);
total.innerText=t.toFixed(2);

if(payment==="cash"){
const r=(+received.value||0)-t;
returnAmt.innerText=r.toFixed(2);
returnBox.classList.toggle("negative",r<0);
}
}

async function loadTodaySales(){

  const snap = await getDocs(collection(db,"sales"));
  let data = [];

  snap.forEach(d=>{
    const s=d.data();
    if(s.date===today){
      data.push({id:d.id,...s});
    }
  });

  // Sort newest first using createdAt
  data.sort((a,b)=>
    (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)
  );

  let totalAmt=0,broiler=0,country=0,eggs=0,masala=0;

  data.forEach(s=>{
    totalAmt+=Number(s.total)||0;
    broiler+=Number(s.items?.broiler?.qty)||0;
    country+=Number(s.items?.country?.qty)||0;
    eggs+=Number(s.items?.eggs?.qty)||0;
    masala+=Number(s.items?.masala?.amount)||0;
  });

  todaySummary.innerHTML=`
    Total ‚Çπ ${totalAmt.toFixed(2)} |
    Broiler ${broiler.toFixed(3)}kg |
    Country ${country.toFixed(3)}kg |
    Eggs ${eggs} |
    Masala ‚Çπ ${masala.toFixed(2)} |
    Bills ${data.length}
  `;

  todayList.innerHTML = data.map((s,index)=>{

    const time = s.createdAt?.toDate()
      ? s.createdAt.toDate().toLocaleTimeString()
      : "";

    return `
      <div style="background:#f8fafc;padding:12px;border-radius:12px;margin-bottom:10px">

        <div style="display:flex;justify-content:space-between;font-weight:800">
          <span>${time} | ${s.payment?.toUpperCase()}</span>
          <span>‚Çπ${s.total}</span>
        </div>

        ${s.items?.broiler?`
          <div style="font-size:14px">
            üêî Broiler ${s.items.broiler.qty}kg ‚Çπ${s.items.broiler.amount}
          </div>`:''}

        ${s.items?.country?`
          <div style="font-size:14px">
            üêì Country ${s.items.country.qty}kg ‚Çπ${s.items.country.amount}
          </div>`:''}

        ${s.items?.eggs?`
          <div style="font-size:14px">
            ü•ö Eggs ${s.items.eggs.qty} ‚Çπ${s.items.eggs.amount}
          </div>`:''}

        ${s.items?.masala?`
          <div style="font-size:14px">
            üå∂ Masala ‚Çπ${s.items.masala.amount}
          </div>`:''}

      </div>
    `;
  }).join("") || "No sales today";
}

window.confirmSale = async()=>{

try{

let items={};
let finalTotal=0;
let totalCost=0;

// Prevent empty sale
if(!active.broiler && !active.country && !active.egg && !active.masala){
alert("No items selected");
return;
}

/* üêî BROILER */
if(active.broiler){
const rate=+broilerPrice.value||0;
const qty=mode.broiler==="kg"
?+broilerKg.value
:(+broilerRs.value/rate||0);

if(qty>0){
const amount=qty*rate;
const cost=await deductStock("broiler",qty);

items.broiler={
qty:+qty.toFixed(3),
rate,
amount:+amount.toFixed(2),
cost
};

finalTotal+=amount;
totalCost+=cost;
}
}

/* üêì COUNTRY */
if(active.country){
const rate=+countryPrice.value||0;
const qty=mode.country==="kg"
?+countryKg.value
:(+countryRs.value/rate||0);

if(qty>0){
const amount=qty*rate;
const cost=await deductStock("country",qty);

items.country={
qty:+qty.toFixed(3),
rate,
amount:+amount.toFixed(2),
cost
};

finalTotal+=amount;
totalCost+=cost;
}
}

/* ü•ö EGGS */
if(active.egg){
const qty=+eggQty.value||0;
const rate=+eggPrice.value||0;

if(qty>0){
const amount=qty*rate;
const cost=await deductStock("eggs",qty);

items.eggs={
qty,
rate,
amount:+amount.toFixed(2),
cost
};

finalTotal+=amount;
totalCost+=cost;
}
}

/* üå∂ MASALA */
if(active.masala){
const amount=+masalaAmt.value||0;

if(amount>0){
// assume one packet sold per entry
const qty=1;

const cost=await deductStock("masala",qty);

items.masala={
qty,
amount:+amount.toFixed(2),
cost
};

finalTotal+=amount;
totalCost+=cost;
}
}

const profit = finalTotal-totalCost;

await addDoc(collection(db,"sales"),{
date:today,
items,
total:+finalTotal.toFixed(2),
totalCost:+totalCost.toFixed(2),
profit:+profit.toFixed(2),
payment,
createdAt:serverTimestamp()
});

alert("Sale saved");

// Reset only billing fields
active = {broiler:false,country:false,egg:false,masala:false};

document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
document.querySelectorAll(".card[id$='Box']").forEach(b=>b.style.display="none");

broilerKg.value="";
broilerRs.value="";
countryKg.value="";
countryRs.value="";
eggQty.value="";
masalaAmt.value="";
received.value="";

payment=null;
total.innerText="0.00";
returnAmt.innerText="0.00";
returnBox.style.display="none";
received.style.display="none";

// Reload today sales list only
loadTodaySales();

}catch(e){
alert(e.message);
}
};
async function loadTodayPrices(){
  const snap = await getDocs(collection(db,"dailyPrices"));
  let latest = null;

  snap.forEach(doc=>{
    const d = doc.data();
    if(d.date === today){
      if(!latest || (d.updatedAtMs && d.updatedAtMs > latest.updatedAtMs)){
        latest = d;
      }
    }
  });

  if(latest){
    broilerPrice.value = latest.broilerPrice || "";
    countryPrice.value = latest.countryPrice || "";
    eggPrice.value = latest.eggPrice || "";
  }
}


async function deductStock(type, quantity){

  let remaining = quantity;
  let totalCost = 0;

  const q = query(
    collection(db,"stock_entries"),
    where("type","==",type),
    where("status","==","active"),
    orderBy("createdAt")
  );

  const snap = await getDocs(q);

  for(const d of snap.docs){

    if(remaining <= 0) break;

    const batch = d.data();

    const available = (type==="broiler" || type==="country")
      ? batch.remainingKg
      : batch.remainingQty;

    const take = Math.min(available, remaining);

    if(type==="broiler" || type==="country"){

      totalCost += take * batch.costPerSellableKg;

      await updateDoc(d.ref,{
        remainingKg: available - take,
        status: (available - take)<=0 ? "closed" : "active"
      });

    }else{

      totalCost += take * batch.costPerUnit;

      await updateDoc(d.ref,{
        remainingQty: available - take,
        status: (available - take)<=0 ? "closed" : "active"
      });
    }

    remaining -= take;
  }

  if(remaining > 0){
    throw new Error("Insufficient stock for "+type);
  }

  return +totalCost.toFixed(2);
}

loadTodayPrices();
loadTodaySales();

</script>

</body>
</html>
