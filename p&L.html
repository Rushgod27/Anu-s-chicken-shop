<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Profit / Loss ‚Äì Anu‚Äôs Chicken Shop</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f1f5f9;
}

.header{
  background:linear-gradient(135deg,#4f46e5,#6366f1);
  color:#fff;
  padding:18px;
  font-size:26px;
  font-weight:900;
  text-align:center;
}

.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

.card{
  background:#fff;
  border-radius:20px;
  padding:18px;
  margin-bottom:20px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}

.row{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

input,button{
  padding:12px;
  font-size:16px;
  border-radius:12px;
  border:1px solid #cbd5f5;
}

button{
  background:#4f46e5;
  color:#fff;
  font-weight:900;
  border:none;
  cursor:pointer;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}

.stat{
  padding:18px;
  border-radius:18px;
  background:#f8fafc;
}

.stat h4{
  margin:0 0 6px;
  color:#475569;
}

.stat .val{
  font-size:28px;
  font-weight:900;
}

.green{color:#16a34a}
.red{color:#dc2626}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:12px;
  border-bottom:1px dashed #ddd;
  text-align:center;
}

th{
  background:#eef2ff;
}

.empty{
  text-align:center;
  color:#64748b;
  padding:20px;
}
</style>
</head>

<body>

<div class="header">üìä Profit / Loss</div>

<div class="container">

<!-- DATE RANGE -->
<div class="card">
<div class="row">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="loadProfit()">Apply</button>
</div>
</div>

<!-- SUMMARY -->
<div class="card stats">
  <div class="stat">
    <h4>Total Revenue</h4>
    <div class="val" id="rev">‚Çπ0</div>
  </div>
  <div class="stat">
    <h4>Total Cost</h4>
    <div class="val" id="cost">‚Çπ0</div>
  </div>
  <div class="stat">
    <h4>Profit / Loss</h4>
    <div class="val" id="profit">‚Çπ0</div>
  </div>
  <div class="stat">
    <h4>Margin %</h4>
    <div class="val" id="margin">0%</div>
  </div>
</div>

<!-- ITEM TABLE -->
<div class="card">
<table>
<thead>
<tr>
  <th>Item</th>
  <th>Sold Qty</th>
  <th>Revenue</th>
  <th>Cost</th>
  <th>P / L</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
<div id="empty" class="empty" style="display:none">
No sales found for selected date range
</div>
</div>

</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, Timestamp
} from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

initializeApp({
  apiKey:"AIzaSyComVLxo36wvogoBFEoWyea-_yESW9BIPU",
  authDomain:"anus-chicken-shop.firebaseapp.com",
  projectId:"anus-chicken-shop"
});

const db = getFirestore();

/* DEFAULT DATES = TODAY */
const today = new Date().toISOString().slice(0,10);
fromDate.value = today;
toDate.value = today;

window.loadProfit = async () => {
  const start = new Date(fromDate.value);
  const end = new Date(toDate.value);
  end.setHours(23,59,59);

  let revenue = 0, cost = 0;
  let items = {
    broiler:{qty:0,rev:0,cost:0},
    country:{qty:0,rev:0,cost:0}
  };

  const q = query(
    collection(db,"sales"),
    where("createdAt",">=",Timestamp.fromDate(start)),
    where("createdAt","<=",Timestamp.fromDate(end))
  );

  const snap = await getDocs(q);

  if (snap.empty){
    empty.style.display="block";
    tableBody.innerHTML="";
    rev.innerText="‚Çπ0";
    cost.innerText="‚Çπ0";
    profit.innerText="‚Çπ0";
    margin.innerText="0%";
    return;
  }

  empty.style.display="none";

  snap.forEach(d=>{
    const s=d.data();
    revenue += s.totalRevenue || 0;
    cost += s.totalCost || 0;

    if(s.items?.broiler){
      items.broiler.qty += s.items.broiler.qty;
      items.broiler.rev += s.items.broiler.revenue;
      items.broiler.cost += s.items.broiler.cost;
    }

    if(s.items?.country){
      items.country.qty += s.items.country.qty;
      items.country.rev += s.items.country.revenue;
      items.country.cost += s.items.country.cost;
    }
  });

  const prof = revenue - cost;

  rev.innerText = "‚Çπ" + revenue.toFixed(2);
  cost.innerText = "‚Çπ" + cost.toFixed(2);
  profit.innerText = "‚Çπ" + prof.toFixed(2);
  profit.className = "val " + (prof>=0?"green":"red");
  margin.innerText = revenue
    ? ((prof/revenue)*100).toFixed(1)+"%"
    : "0%";

  tableBody.innerHTML = `
<tr>
<td>üêî Broiler</td>
<td>${items.broiler.qty.toFixed(2)} kg</td>
<td>‚Çπ${items.broiler.rev.toFixed(2)}</td>
<td>‚Çπ${items.broiler.cost.toFixed(2)}</td>
<td class="${items.broiler.rev-items.broiler.cost>=0?"green":"red"}">
‚Çπ${(items.broiler.rev-items.broiler.cost).toFixed(2)}
</td>
</tr>

<tr>
<td>üêì Country</td>
<td>${items.country.qty.toFixed(2)} kg</td>
<td>‚Çπ${items.country.rev.toFixed(2)}</td>
<td>‚Çπ${items.country.cost.toFixed(2)}</td>
<td class="${items.country.rev-items.country.cost>=0?"green":"red"}">
‚Çπ${(items.country.rev-items.country.cost).toFixed(2)}
</td>
</tr>`;
};

loadProfit();
</script>

</body>
</html>
